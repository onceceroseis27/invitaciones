<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Confirmación</title>
<style>
  body { font-family: Arial, sans-serif; background:#f8f2ec; margin:0; padding:20px; }
  form { max-width:480px; margin:30px auto; background:#fff; padding:18px; border-radius:10px; }
  label { display:block; margin-top:10px; font-weight:600; }
  input[type="text"], input[type="number"], textarea, select { width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-top:6px; }
  textarea { min-height:90px; }
  .hidden { display:none; }
  button { margin-top:14px; width:100%; padding:12px; background:#c5a27a; color:#fff; border:none; border-radius:8px; cursor:pointer; }
  .error { color:#b33; margin-top:8px; }
</style>
</head>
<body>
<form id="formulario">
  <h2>Confirmación de asistencia</h2>
    <label for="nombres">Nombre(s) (si no vas, indica tu nombre)</label>
      <input id="nombres" type="text" placeholder="Ej: Ana García" required />
      <label for="asistencia">¿Asistirás?</label>
  <select id="asistencia" required>
    <option value="">Selecciona...</option>
    <option value="Sí">Sí</option>
    <option value="No">No</option>
  </select>

  <div id="block-num" class="hidden">
    <label for="num_personas">Número de personas</label>
    <input id="num_personas" type="number" min="1" placeholder="Incluyéndote" />
  </div>

  <div id="block-bus" class="hidden">
    <label for="usar_bus">¿Haréis uso del autobús?</label>
    <select id="usar_bus">
      <option value="">Seleccione...</option>
      <option value="Sí">Sí</option>
      <option value="No">No</option>
    </select>
  </div>

  <div id="block-bus-detalles" class="hidden">
    <label for="trayectos">¿Qué trayecto/s tienes pensado hacer?</label>
    <select id="trayectos">
      <option value="">Seleccione...</option>
      <option value="Ida">Ida</option>
      <option value="Vuelta">Vuelta</option>
      <option value="Ida y vuelta">Ida y vuelta</option>
    </select>

    <div id="block-salida" class="hidden">
      <label for="salida">Lugar de salida</label>
      <select id="salida">
        <option value="">Seleccione...</option>
        <option value="Pedroso">Pedroso</option>
        <option value="Cayón">Cayón</option>
      </select>
    </div>

    <label for="llegada">Lugar de llegada</label>
    <select id="llegada">
      <option value="">Seleccione...</option>
      <option value="Pedroso">Pedroso</option>
      <option value="Cayón">Cayón</option>
    </select>

    <label for="hora">Hora de salida</label>
    <select id="hora">
      <option value="">Seleccione...</option>
      <option value="1:30">1:30</option>
      <option value="4:30">4:30</option>
    </select>
  </div>

  <label for="comentarios">Comentarios adicionales</label>
  <textarea id="comentarios" placeholder="Opcional"></textarea>

  <div id="error" class="error hidden"></div>
  <button type="submit" id="submitBtn">Enviar confirmación</button>
</form>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfp5fIYv7c6JGVL9beSgoSzY_gCT_SVZGcSnU6AiRcJraAn7Yy9jbUPe95Ny7oboOq/exec";

const $ = id => document.getElementById(id);
const form = $('formulario');
const asistencia = $('asistencia');
const blockNum = $('block-num');
const num_personas = $('num_personas');
const nombres = $('nombres');
const blockBus = $('block-bus');
const usar_bus = $('usar_bus');
const blockBusDetalles = $('block-bus-detalles');
const trayectos = $('trayectos');
const blockSalida = $('block-salida');
const salida = $('salida');
const llegada = $('llegada');
const hora = $('hora');
const comentarios = $('comentarios');
const errorBox = $('error');
const submitBtn = $('submitBtn');
const now = new Date();
const fechaFormateada = now.getFullYear() + "-" 
                       + String(now.getMonth() + 1).padStart(2,'0') + "-"
                       + String(now.getDate()).padStart(2,'0');

function show(el){ el.classList.remove('hidden'); }
function hide(el){ if(!el.classList.contains('hidden')) el.classList.add('hidden'); }
function showError(msg){ errorBox.textContent = msg; errorBox.classList.remove('hidden'); }

asistencia.addEventListener('change', () => {
  errorBox.classList.add('hidden');
  if (asistencia.value === 'Sí') {
    show(blockNum);
    show(blockBus);
    num_personas.required = true;
    usar_bus.required = true;
  } else {
    hide(blockNum);
    hide(blockBus);
    hide(blockBusDetalles);
    hide(blockSalida);
    num_personas.required = false;
    usar_bus.required = false;
  }
});

usar_bus.addEventListener('change', () => {
  errorBox.classList.add('hidden');
  if (usar_bus.value === 'Sí') {
    show(blockBusDetalles);
    trayectos.required = true;
    llegada.required = true;
    hora.required = true;
  } else {
    hide(blockBusDetalles);
    hide(blockSalida);
    trayectos.required = false;
    salida.required = false;
    llegada.required = false;
    hora.required = false;
  }
});

trayectos.addEventListener('change', () => {
  if (trayectos.value === 'Ida' || trayectos.value === 'Ida y vuelta') {
    show(blockSalida);
    salida.required = true;
  } else {
    hide(blockSalida);
    salida.required = false;
  }
});

form.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  errorBox.classList.add('hidden');

  // Validaciones
  if (!asistencia.value) { showError('Selecciona si asistirás o no.'); return; }
  if (!nombres.value.trim()) { showError('Indica el nombre aunque no asistas.'); return; }
  if (asistencia.value === 'Sí' && (!num_personas.value || Number(num_personas.value) < 1)) { showError('Indica un número de personas válido.'); return; }
  if (asistencia.value === 'Sí' && usar_bus.value === 'Sí') {
    if (!trayectos.value) { showError('Selecciona trayecto'); return; }
    if ((trayectos.value === 'Ida' || trayectos.value === 'Ida y vuelta') && !salida.value) { showError('Selecciona lugar de salida'); return; }
    if (!llegada.value) { showError('Selecciona lugar de llegada'); return; }
    if (!hora.value) { showError('Selecciona hora de salida'); return; }
  }

const payload = {
  num_personas: (asistencia.value === 'Sí') ? (num_personas.value || '') : '',
  nombres: nombres.value.trim(),
  asistencia: asistencia.value,
  fecha: fechaFormateada,
  comentarios: comentarios.value.trim() || '',
  bus: (asistencia.value === 'Sí') ? (usar_bus.value || 'No') : '',
  trayectos: (usar_bus.value === 'Sí') ? (trayectos.value || '') : '',
  salida: (usar_bus.value === 'Sí') ? (salida.value || '') : '',
  llegada: (usar_bus.value === 'Sí') ? (llegada.value || '') : '',
  hora: (usar_bus.value === 'Sí') ? (getSelectedHour() || '') : ''
};


  // Deshabilitar botón y mostrar “Enviando…”
  submitBtn.disabled = true;
  submitBtn.textContent = 'Enviando...';

  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: new URLSearchParams(payload).toString()
    });

    // Redirigir aunque la respuesta no tenga CORS
    window.location.href = 'mensaje.html?nombre=' + encodeURIComponent(payload.nombres);

  } catch (err) {
    console.error(err);
    showError('Error de conexión al enviar los datos. Inténtalo de nuevo más tarde.');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Enviar confirmación';
  }
});
</script>
</body>
</html>
